<%- include('../partials/header', { title: lesson.title + ' - C Programming', currentPage: 'c-programming' }) %>

<link rel="stylesheet" href="/css/c-programming.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

<main class="main-content">
    <div class="lesson-page-container">
        <!-- Sidebar Navigation -->
        <aside class="lesson-sidebar">
            <div class="sidebar-header">
                <a href="/c-programming" class="sidebar-back">
                    <i class="fas fa-arrow-left"></i> Curriculum
                </a>
                <h3>C Programming</h3>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <h4>Level 1: Fundamentals</h4>
                    <ul>
                        <% allLessons.filter(l => l.level === 1).forEach(l => { %>
                        <li class="<%= l.topic === lesson.topic ? 'active' : '' %>">
                            <a href="/c-programming/<%= l.topic %>">
                                <i class="fas fa-<%= l.topic === lesson.topic ? 'circle' : 'circle-o' %>"></i>
                                <%= l.title %>
                            </a>
                        </li>
                        <% }); %>
                    </ul>
                </div>
                <div class="nav-section">
                    <h4>Level 2: Advanced</h4>
                    <ul>
                        <% allLessons.filter(l => l.level === 2).forEach(l => { %>
                        <li class="<%= l.topic === lesson.topic ? 'active' : '' %>">
                            <a href="/c-programming/<%= l.topic %>">
                                <i class="fas fa-<%= l.topic === lesson.topic ? 'circle' : 'circle-o' %>"></i>
                                <%= l.title %>
                            </a>
                        </li>
                        <% }); %>
                    </ul>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="lesson-content-wrapper">
            <!-- Breadcrumb -->
            <nav class="breadcrumb">
                <a href="/c-programming">C Programming</a>
                <span class="separator">></span>
                <a href="/c-programming/level/<%= lesson.level %>">Level <%= lesson.level %></a>
                <span class="separator">></span>
                <span class="current"><%= lesson.title %></span>
            </nav>

            <!-- Lesson Header -->
            <header class="lesson-header">
                <h1><%= lesson.title %></h1>
                <div class="lesson-meta">
                    <span class="time-estimate">
                        <i class="fas fa-clock"></i> ~<%= lesson.estimatedTime || 30 %> min
                    </span>
                    <span class="difficulty <%= lesson.level === 1 ? 'beginner' : 'advanced' %>">
                        <%= lesson.level === 1 ? 'Beginner' : 'Advanced' %>
                    </span>
                    <% if (progress.status === 'completed') { %>
                    <span class="status-completed">
                        <i class="fas fa-check-circle"></i> Completed
                    </span>
                    <% } else if (progress.status === 'in_progress') { %>
                    <span class="status-progress">
                        <i class="fas fa-spinner"></i> In Progress
                    </span>
                    <% } %>
                </div>
            </header>

            <!-- Theory Section -->
            <section class="theory-section">
                <h2><i class="fas fa-book"></i> Theory</h2>
                <div class="theory-content">
                    <% 
                    // Process markdown-style formatting
                    let content = lesson.content || '';
                    
                    // Remove any existing HTML tags that might interfere (from previous renders)
                    content = content.replace(/<br\s*\/?>/gi, '\n');
                    content = content.replace(/<p[^>]*>/gi, '');
                    content = content.replace(/<\/p>/gi, '\n\n');
                    
                    // Handle escaped backticks from seed data
                    content = content.replace(/\\`/g, '`');
                    
                    // Split into paragraphs (double line breaks)
                    let paragraphs = content.split(/\n\n+/);
                    let formattedContent = paragraphs.map(para => {
                        para = para.trim();
                        if (!para) return '';
                        
                        // Check if it's a header (starts with ** and ends with **, on its own line)
                        let headerMatch = para.match(/^\*\*([^*]+)\*\*$/);
                        if (headerMatch) {
                            return '<h3>' + headerMatch[1] + '</h3>';
                        }
                        
                        // Check if it's a list (starts with -)
                        if (para.match(/^- /)) {
                            let listItems = para.split(/\n/).filter(line => line.trim().match(/^- /)).map(item => {
                                item = item.replace(/^- /, '').trim();
                                // Process inline formatting in list items
                                item = item.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                                item = item.replace(/`([^`]+)`/g, '<code class="inline-code">$1</code>');
                                return '<li>' + item + '</li>';
                            }).join('');
                            return '<ul>' + listItems + '</ul>';
                        }
                        
                        // Regular paragraph - process inline formatting
                        para = para.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                        para = para.replace(/`([^`]+)`/g, '<code class="inline-code">$1</code>');
                        para = para.replace(/\n/g, '<br>');
                        
                        return '<p>' + para + '</p>';
                    }).filter(p => p).join('\n');
                    %>
                    <%- formattedContent %>
                </div>
            </section>

            <!-- Code Examples -->
            <% if (lesson.codeExamples && lesson.codeExamples.length > 0) { %>
            <section class="code-section">
                <h2><i class="fas fa-code"></i> Code Examples</h2>
                <% lesson.codeExamples.forEach((example, index) => { %>
                <div class="code-example-block">
                    <div class="code-example-header">
                        <h3><%= example.title || `Example ${index + 1}` %></h3>
                        <button class="copy-code-btn" data-code="<%= index %>">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    <% if (example.explanation) { %>
                    <p class="code-explanation"><%= example.explanation %></p>
                    <% } %>
                    <div class="code-block">
                        <pre><code class="language-c" id="code-<%= index %>"><%= example.code %></code></pre>
                    </div>
                </div>
                <% }); %>
            </section>
            <% } %>

            <!-- Live Demo Section -->
            <section class="demo-section">
                <h2><i class="fas fa-play-circle"></i> Try It Yourself</h2>
                <div class="live-editor">
                    <div class="editor-header">
                        <span>Live Code Editor</span>
                        <button class="run-code-btn">
                            <i class="fas fa-play"></i> Run Code
                        </button>
                    </div>
                    <textarea class="code-editor" id="live-editor" placeholder="// Write your C code here..."><% if (lesson.codeExamples && lesson.codeExamples.length > 0) { %><%= lesson.codeExamples[0].code %><% } else { %>#include &lt;stdio.h&gt;

int main() {
    // Your code here
    return 0;
}<% } %></textarea>
                    <div class="output-container">
                        <div class="output-header">
                            <h4>Output:</h4>
                            <button class="clear-output-btn">
                                <i class="fas fa-trash"></i> Clear
                            </button>
                        </div>
                        <div class="code-output" id="code-output"></div>
                    </div>
                </div>
            </section>

            <!-- Exercises Section -->
            <% if (lesson.exercises && lesson.exercises.length > 0) { %>
            <section class="exercise-section">
                <h2><i class="fas fa-dumbbell"></i> Practice Exercises</h2>
                <% lesson.exercises.forEach((exercise, index) => { %>
                <div class="exercise-card" data-exercise="<%= index %>">
                    <div class="exercise-header">
                        <h3>Exercise <%= index + 1 %>: <%= exercise.title %></h3>
                        <span class="difficulty-badge <%= exercise.difficulty %>">
                            <%= exercise.difficulty.charAt(0).toUpperCase() + exercise.difficulty.slice(1) %>
                        </span>
                    </div>
                    <div class="exercise-content">
                        <p><%= exercise.description %></p>
                        <button class="show-solution-btn" data-exercise="<%= index %>">
                            <i class="fas fa-eye"></i> Show Solution
                        </button>
                        <div class="solution hidden" id="solution-<%= index %>">
                            <h4>Solution:</h4>
                            <div class="code-block">
                                <pre><code class="language-c"><%= exercise.solution %></code></pre>
                            </div>
                            <button class="mark-complete-btn" data-exercise="<%= index %>">
                                <i class="fas fa-check"></i> Mark as Complete
                            </button>
                        </div>
                    </div>
                </div>
                <% }); %>
            </section>
            <% } %>

            <!-- Common Mistakes -->
            <section class="mistakes-section">
                <h2><i class="fas fa-exclamation-triangle"></i> Common Mistakes to Avoid</h2>
                <div class="mistakes-list">
                    <div class="mistake-item">
                        <i class="fas fa-times-circle"></i>
                        <div>
                            <strong>Forgetting semicolons:</strong> Every statement in C must end with a semicolon.
                        </div>
                    </div>
                    <div class="mistake-item">
                        <i class="fas fa-times-circle"></i>
                        <div>
                            <strong>Wrong format specifiers:</strong> Use %d for int, %f for float, %c for char, %s for strings.
                        </div>
                    </div>
                    <div class="mistake-item">
                        <i class="fas fa-times-circle"></i>
                        <div>
                            <strong>Not initializing variables:</strong> Always initialize variables before use to avoid undefined behavior.
                        </div>
                    </div>
                </div>
            </section>

            <!-- Lesson Navigation Footer -->
            <footer class="lesson-navigation">
                <button class="nav-btn prev" <%= !prevLesson ? 'disabled' : '' %>>
                    <% if (prevLesson) { %>
                    <a href="/c-programming/<%= prevLesson.topic %>">
                        <i class="fas fa-arrow-left"></i> Previous: <%= prevLesson.title %>
                    </a>
                    <% } else { %>
                    <span><i class="fas fa-arrow-left"></i> Previous</span>
                    <% } %>
                </button>
                <div class="progress-indicator">
                    <% const progressPercent = progress.status === 'completed' ? 100 : 
                        progress.status === 'in_progress' ? 50 : 0; %>
                    <span class="progress-text"><%= progressPercent %>% Complete</span>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: <%= progressPercent %>%"></div>
                    </div>
                </div>
                <button class="nav-btn next" <%= !nextLesson ? 'disabled' : '' %>>
                    <% if (nextLesson) { %>
                    <a href="/c-programming/<%= nextLesson.topic %>">
                        Next: <%= nextLesson.title %> <i class="fas fa-arrow-right"></i>
                    </a>
                    <% } else { %>
                    <span>Next <i class="fas fa-arrow-right"></i></span>
                    <% } %>
                </button>
            </footer>
        </div>
    </div>
</main>

<%- include('../partials/footer') %>
<script src="/js/c-programming.js"></script>
<script src="/js/code-runner.js"></script>
<script>
    // Store lesson data for JavaScript
    window.lessonData = {
        lessonId: '<%= lesson._id %>',
        topic: '<%= lesson.topic %>',
        progress: {
            status: '<%= progress.status %>',
            timeSpent: <%= progress.timeSpent || 0 %>
        }
    };
</script>

